#!/usr/bin/env node

const spawn = require('cross-spawn');
const chalk = require('chalk');

const argv = require('../utils/yargs');
const { checkEntryFile, loadEnv } = require('../utils');

const { log } = console;

process.on('unhandledRejection', (err) => {
  throw err;
});

loadEnv();

const args = process.argv.slice(2);
const scriptIndex = args.findIndex(
  x => x === 'build' || x === 'eject' || x === 'start' || x === 'test',
);
const script = scriptIndex === -1 ? args[0] : args[scriptIndex];
const nodeArgs = scriptIndex > 0 ? args.slice(0, scriptIndex) : [];

const mode = argv.typescript ? 'typescript' : 'javascript';

switch (script) {
  case 'start':
  case 'build':
  case 'test':
    {
      checkEntryFile(mode);

      const argsConcat = nodeArgs
        .concat(require.resolve(`../scripts/${script}`))
        .concat(args.slice(scriptIndex + 1));

      spawn.sync('node', argsConcat, { stdio: 'inherit' });
    }
    break;
  default:
    log(`Unknown script ${chalk.red(script)}`);
    break;
}
